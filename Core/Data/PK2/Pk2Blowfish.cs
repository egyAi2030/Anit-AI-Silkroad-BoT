using System;
using System.Text;

namespace SilkroadAIBot.Core.Data.PK2
{
    public class Pk2Blowfish
    {
        private uint[] P = {
            0x243F6A88, 0x85A308D3, 0x13198A2E, 0x03707344, 0xA4093822, 0x299F31D0, 0x082EFA98, 0xEC4E6C89,
            0x452821E6, 0x38D01377, 0xBE5466CF, 0x34E90C6C, 0xC0AC29B7, 0xC97C50DD, 0x3F84D5B5, 0xB5470917,
            0x9216D5D9, 0x8979FB1B
        };

        private uint[,] S = {
            {   0xD1310BA6, 0x98DFB5AC, 0x2FFD72DB, 0xD01ADFB7, 0xB8E1AFED, 0x6A267E96, 0xBA7C9045, 0xF12C7F99,
                0x24A19947, 0xB3916CF7, 0x0801F2E2, 0x858EFC16, 0x636920D8, 0x71574E69, 0xA458FEA3, 0xF4933D7E,
                0x0D95748F, 0x728EB658, 0x718BCD58, 0x82154AEE, 0x7B54A41D, 0xC25A59B5, 0x9C30D539, 0x2AF26013,
                0xC5D1B023, 0x286085F0, 0xCA417918, 0xB8DB38EF, 0x8E79DCB0, 0x603A180E, 0x6C9E0E8B, 0xB01E8A3E,
                0xD71577C1, 0xBD314B27, 0x78AF2FDA, 0x55605C60, 0xE65525F3, 0xAA55AB94, 0x57489862, 0x63E81440,
                0x55CA396A, 0x2AAB10B6, 0xB4CC5C34, 0x1141E8CE, 0xA15486AF, 0x7C72E993, 0xB3EE1411, 0x636FBC2A,
                0x2BA9C55D, 0x741831F6, 0xCE5C3E16, 0x9B87931E, 0xAFD6BA33, 0x6C24CF5C, 0x7A325381, 0x28958677,
                0x3B8F4898, 0x6B4BB9AF, 0xC4BFE81B, 0x66282193, 0x61D809CC, 0xFB21A991, 0x487CAC60, 0x5DEC8032,
                0xEF845D5D, 0xE98575B1, 0xDC262302, 0xEB651B88, 0x23893E81, 0xD396ACC5, 0x0F6D6FF3, 0x83F44239,
                0x2E0B4482, 0xA4842004, 0x69C8F04A, 0x9E1F9B5E, 0x21C66842, 0xF6E96C9A, 0x670C9C61, 0xABD388F0,
                0x6A51A0D2, 0xD8542F68, 0x960FA728, 0xAB5133A3, 0x6EEF0B6C, 0x137A3BE4, 0xBA3BF050, 0x7EFB2A98,
                0xA1F1651D, 0x39AF0176, 0x66CA593E, 0x82430E88, 0x8CEE8619, 0x456F9FB4, 0x7D84A5C3, 0x3B8B5EBE,
                0xE06F75D8, 0x85C12073, 0x401A449F, 0x56C16AA6, 0x4ED3AA62, 0x363F7706, 0x1BFEDF72, 0x429B023D,
                0x37D0D724, 0xD00A1248, 0xDB0FEAD3, 0x49F1C09B, 0x075372C9, 0x80991B7B, 0x25D479D8, 0xF6E8DEF7,
                0xE3FE501A, 0xB6794C3B, 0x976CE0BD, 0x04C006BA, 0xC1A94FB6, 0x409F60C4, 0x5E5C9EC2, 0x196A2463,
                0x68FB6FAF, 0x3E6C53B5, 0x1339B2EB, 0x3B52EC6F, 0x6DFC511F, 0x9B30952C, 0xCC814544, 0xAF5EBD09,
                0xBEE3D004, 0xDE334AFD, 0x660F2807, 0x192E4BB3, 0xC0CBA857, 0x45C8740F, 0xD20B5F39, 0xB9D3FBDB,
                0x5579C0BD, 0x1A60320A, 0xD6A100C6, 0x402C7279, 0x679F25FE, 0xFB1FA3CC, 0x8EA5E9F8, 0xDB3222F8,
                0x3C7516DF, 0xFD616B15, 0x2F501EC8, 0xAD0552AB, 0x323DB5FA, 0xFD238760, 0x53317B48, 0x3E00DF82,
                0x9E5C57BB, 0xCA6F8CA0, 0x1A87562E, 0xDF1769DB, 0xD542A8F6, 0x287EFFC3, 0xAC6732C6, 0x8C4F5573,
                0x695B27B0, 0xBBCA58C8, 0xE1FFA35D, 0xB8F011A0, 0x10FA3D98, 0xFD2183B8, 0x4AFCB56C, 0x2DD1D35B,
                0x9A53E479, 0xB6F84565, 0xD28E49BC, 0x4BFB9790, 0xE1DDF2DA, 0xA4CB7E33, 0x62FB1341, 0xCEE4C6E8,
                0xEF20CADA, 0x36774C01, 0xD07E9EFE, 0x2BF11FB4, 0x95DB0A28, 0x6865817A, 0xB45ED588, 0x08158026,
                0x34F55896, 0x8A2222F6, 0x0119096F, 0x4C80062D, 0x26FD4A8F, 0x9C645A80, 0xDFC163D7, 0x0A98099C,
                0x30E067B1, 0xD1857207, 0x49EE0980, 0x3A037Cde, 0x39D275A4, 0xF94B8770, 0x19C46147, 0x6D43806E,
                0x285913D8, 0x67F91559, 0xF8087611, 0x2035F4C7, 0x49013098, 0x34C22164, 0x22802DE8, 0x38417088,
                0xFEF24C41, 0xD991CD6C, 0x4384CC39, 0x89C613A8, 0x6C729352, 0xEB598836, 0xA99D4171, 0x22D770E3,
                0xDBAC5462, 0xFD4684AD, 0x8C9A7480, 0x7687820B, 0x71AB7D76, 0x0FDD6810, 0xE7102075, 0x401D397F,
                0x56E03260, 0x35607996, 0x7A740192, 0xDBFC1433, 0x407A6560, 0x79469766, 0x8D387BC3, 0x8D3E32C4,
                0x00A03164, 0x992451C3, 0x708C5C82, 0x0F013446, 0xD997C99E, 0x51CB5861, 0xEA9E01F7, 0x066539C7,
                0xEA2A7553, 0x946110BC, 0x8C56F985, 0xE7A1F261, 0x546D2967, 0x5189ED89, 0xC4DB7037, 0xF5C9C8B5,
                0xBC474327, 0x0F7142A9, 0x361667A5, 0xB663C1E4, 0xE8B8D733, 0x20E30D6C, 0xA1A13978, 0xAEE52613 },

            {   0x2213431D, 0xD99CD018, 0xD564757C, 0x5462D4D0, 0x6885444D, 0x91F51659, 0x97302484, 0x40316909,
                0x73DAF65A, 0x93318FDC, 0x286F70B0, 0x5CCF5A31, 0xD297C52D, 0x0091DB31, 0x723D4719, 0x454F6F4C,
                0x673C1A14, 0x9E99052E, 0x0602D214, 0x76B63B66, 0x8D0F3F19, 0x705F41C9, 0x1B072782, 0xDAF046B1,
                0xE91B07F0, 0xA187E604, 0x70903333, 0xBDB48529, 0xA1384033, 0xD66C8C70, 0xC8D3A8FF, 0x62956276,
                0xD08B815D, 0x27CFA721, 0x8E8F5D0D, 0x9937E848, 0x153676E9, 0xB4D5220F, 0x8F59B518, 0xF94697F4,
                0x18F64491, 0xEA396860, 0x78931F57, 0xC4246757, 0x624D0F1F, 0x14D02181, 0x2F71F7A4, 0x7A0D23FC,
                0xC17F38FA, 0x4E7471F8, 0xE7B8D69A, 0x35634628, 0xF2461C02, 0x20E418A3, 0x4963BD07, 0x367F7C77,
                0xC5B4CC29, 0xA3EE8552, 0x11749C28, 0xE2025178, 0x6854580D, 0x7B9C3482, 0xDA0B5D34, 0xF1334E24,
                0x0E5002C9, 0x08F356C4, 0x1A2A69A4, 0x60CD9CD7, 0xCEAA4E52, 0xB18E7F07, 0xD702B413, 0x6FA39794,
                0xE8912C85, 0x477FCD15, 0x05B011BC, 0xA5880B44, 0x309C88C0, 0x33A64DC0, 0x09B03140, 0x2382D420,
                0xECC2A2C6, 0xDC6D8D27, 0xB4E72D1E, 0x70E44D12, 0xBE2C0E21, 0x339A682D, 0x510D9921, 0xA3F2D409,
                0x00A40582, 0x6334547B, 0xE1D1AE1C, 0xA210F65D, 0xB154C4AE, 0x567118B8, 0x616F8246, 0xDB997782,
                0xA84D01FD, 0x4989658E, 0xF34A9996, 0xE18A0160, 0x93301B5D, 0x153A8187, 0x4F8CA00E, 0x0DB8C2E4,
                0xC154E862, 0x630E53B0, 0x1E598379, 0xA8ED4F0F, 0x98BE9990, 0x3F68C31D, 0xF9487009, 0x629D4539,
                0x0A2B1123, 0xC386820C, 0x930D382B, 0xBC17D508, 0x76B13583, 0xE8F9C425, 0x4F0B5270, 0x3AA38A18,
                0x1588820A, 0x22874136, 0xFC117765, 0x0374100D, 0xBA07B7A6, 0xAE198C6D, 0xB880A1BA, 0xF6B21F7B,
                0xC264D0F5, 0x83B7F1FE, 0xC49DF6F6, 0x501C46D1, 0x14515286, 0xE1495945, 0x3D463870, 0xC6A1A7D8,
                0xD0A3097C, 0x8085B948, 0x57640306, 0x8B75D765, 0xF4F62160, 0xFE39121E, 0x55030805, 0x03B99757,
                0x4B3A8B10, 0xD4C19A0A, 0xBA718AB4, 0x205FCD7C, 0x18B478EA, 0x20E150F3, 0xA4F2B76D, 0x5466C7E2,
                0x57551068, 0x45E2024E, 0x907BBAF9, 0xEAF98F2F, 0x94833214, 0x33A64099, 0xC5779679, 0x3D757BA2,
                0x3429F64B, 0x17A656F0, 0xBA010C42, 0xC0B24719, 0x18D3776C, 0x2805FF7B, 0x3A02137F, 0x0375E010,
                0x18F6AE29, 0x3412B9D9, 0xAD869151, 0x9B100E9C, 0xF54A3B43, 0x2C465664, 0x86D491E4, 0x6C7E4362,
                0x738A89A6, 0x296B6488, 0xE6503939, 0x534F6A24, 0x00F95146, 0xEE7F3082, 0x1634B599, 0x6E4C2366,
                0x91F79D3B, 0x036F90E1, 0x1E428172, 0x310E9892, 0xB045FCAB, 0x7E3707B8, 0x9A6B2966, 0x457223D9,
                0xC174F8B3, 0x8C11C9C5, 0x9735160E, 0x3B6D2687, 0x80556105, 0x794695BF, 0x8A1E7F35, 0x848A7527,
                0x7E8B830D, 0x90197771, 0x10E17726, 0xbf93B280, 0x19277A6C, 0x79247E53, 0x074FD518, 0x1F2A7E4F,
                0xBB73C08D, 0xC0853545, 0xD66C1536, 0x3E11D925, 0x7460D8F1, 0xAB84643F, 0x3648DAF7, 0x2B452445,
                0xD9766946, 0x62B2F484, 0xB66D3D58, 0x4D2A478B, 0xCB92D956, 0xE5847F22, 0x27242E61, 0x7F91C9A4,
                0x57A56360, 0x546D2989, 0x6D43806E, 0x27916A46, 0xB880A1BA, 0xF6B21F7B, 0x67F91559, 0xF8087611,
                0x285913D8, 0x56E03260, 0x35607996, 0x7A740192, 0xDBFC1433, 0x407A6560, 0x79469766, 0x8D387BC3,
                0x2213431D, 0xD99CD018, 0xD564757C, 0x5462D4D0, 0x6885444D, 0x91F51659, 0x97302484, 0x40316909,
                0x73DAF65A, 0x93318FDC, 0x286F70B0, 0x5CCF5A31, 0xD297C52D, 0x0091DB31, 0x723D4719, 0x454F6F4C },
            
            {   0x2213431D, 0xD99CD018, 0xD564757C, 0x5462D4D0, 0x6885444D, 0x91F51659, 0x97302484, 0x40316909,
                0x73DAF65A, 0x93318FDC, 0x286F70B0, 0x5CCF5A31, 0xD297C52D, 0x0091DB31, 0x723D4719, 0x454F6F4C,
                0x673C1A14, 0x9E99052E, 0x0602D214, 0x76B63B66, 0x8D0F3F19, 0x705F41C9, 0x1B072782, 0xDAF046B1,
                0xE91B07F0, 0xA187E604, 0x70903333, 0xBDB48529, 0xA1384033, 0xD66C8C70, 0xC8D3A8FF, 0x62956276,
                0xD08B815D, 0x27CFA721, 0x8E8F5D0D, 0x9937E848, 0x153676E9, 0xB4D5220F, 0x8F59B518, 0xF94697F4,
                0x18F64491, 0xEA396860, 0x78931F57, 0xC4246757, 0x624D0F1F, 0x14D02181, 0x2F71F7A4, 0x7A0D23FC,
                0xC17F38FA, 0x4E7471F8, 0xE7B8D69A, 0x35634628, 0xF2461C02, 0x20E418A3, 0x4963BD07, 0x367F7C77,
                0xC5B4CC29, 0xA3EE8552, 0x11749C28, 0xE2025178, 0x6854580D, 0x7B9C3482, 0xDA0B5D34, 0xF1334E24,
                0x0E5002C9, 0x08F356C4, 0x1A2A69A4, 0x60CD9CD7, 0xCEAA4E52, 0xB18E7F07, 0xD702B413, 0x6FA39794,
                0xE8912C85, 0x477FCD15, 0x05B011BC, 0xA5880B44, 0x309C88C0, 0x33A64DC0, 0x09B03140, 0x2382D420,
                0xECC2A2C6, 0xDC6D8D27, 0xB4E72D1E, 0x70E44D12, 0xBE2C0E21, 0x339A682D, 0x510D9921, 0xA3F2D409,
                0x00A40582, 0x6334547B, 0xE1D1AE1C, 0xA210F65D, 0xB154C4AE, 0x567118B8, 0x616F8246, 0xDB997782,
                0xA84D01FD, 0x4989658E, 0xF34A9996, 0xE18A0160, 0x93301B5D, 0x153A8187, 0x4F8CA00E, 0x0DB8C2E4,
                0xC154E862, 0x630E53B0, 0x1E598379, 0xA8ED4F0F, 0x98BE9990, 0x3F68C31D, 0xF9487009, 0x629D4539,
                0x0A2B1123, 0xC386820C, 0x930D382B, 0xBC17D508, 0x76B13583, 0xE8F9C425, 0x4F0B5270, 0x3AA38A18,
                0x1588820A, 0x22874136, 0xFC117765, 0x0374100D, 0xBA07B7A6, 0xAE198C6D, 0xB880A1BA, 0xF6B21F7B,
                0xC264D0F5, 0x83B7F1FE, 0xC49DF6F6, 0x501C46D1, 0x14515286, 0xE1495945, 0x3D463870, 0xC6A1A7D8,
                0xD0A3097C, 0x8085B948, 0x57640306, 0x8B75D765, 0xF4F62160, 0xFE39121E, 0x55030805, 0x03B99757,
                0x4B3A8B10, 0xD4C19A0A, 0xBA718AB4, 0x205FCD7C, 0x18B478EA, 0x20E150F3, 0xA4F2B76D, 0x5466C7E2,
                0x57551068, 0x45E2024E, 0x907BBAF9, 0xEAF98F2F, 0x94833214, 0x33A64099, 0xC5779679, 0x3D757BA2,
                0x3429F64B, 0x17A656F0, 0xBA010C42, 0xC0B24719, 0x18D3776C, 0x2805FF7B, 0x3A02137F, 0x0375E010,
                0x18F6AE29, 0x3412B9D9, 0xAD869151, 0x9B100E9C, 0xF54A3B43, 0x2C465664, 0x86D491E4, 0x6C7E4362,
                0x738A89A6, 0x296B6488, 0xE6503939, 0x534F6A24, 0x00F95146, 0xEE7F3082, 0x1634B599, 0x6E4C2366,
                0x91F79D3B, 0x036F90E1, 0x1E428172, 0x310E9892, 0xB045FCAB, 0x7E3707B8, 0x9A6B2966, 0x457223D9,
                0xC174F8B3, 0x8C11C9C5, 0x9735160E, 0x3B6D2687, 0x80556105, 0x794695BF, 0x8A1E7F35, 0x848A7527,
                0x7E8B830D, 0x90197771, 0x10E17726, 0xbf93B280, 0x19277A6C, 0x79247E53, 0x074FD518, 0x1F2A7E4F,
                0xBB73C08D, 0xC0853545, 0xD66C1536, 0x3E11D925, 0x7460D8F1, 0xAB84643F, 0x3648DAF7, 0x2B452445,
                0xD9766946, 0x62B2F484, 0xB66D3D58, 0x4D2A478B, 0xCB92D956, 0xE5847F22, 0x27242E61, 0x7F91C9A4,
                0x57A56360, 0x546D2989, 0x6D43806E, 0x27916A46, 0xB880A1BA, 0xF6B21F7B, 0x67F91559, 0xF8087611,
                0x285913D8, 0x56E03260, 0x35607996, 0x7A740192, 0xDBFC1433, 0x407A6560, 0x79469766, 0x8D387BC3,
                0x2213431D, 0xD99CD018, 0xD564757C, 0x5462D4D0, 0x6885444D, 0x91F51659, 0x97302484, 0x40316909,
                0x73DAF65A, 0x93318FDC, 0x286F70B0, 0x5CCF5A31, 0xD297C52D, 0x0091DB31, 0x723D4719, 0x454F6F4C },
        };

        public void Initialize(byte[] key)
        {
            if (key == null || key.Length == 0) return;

            int n = 0;
            for (int i = 0; i < 18; ++i)
            {
                uint d = 0;
                for (int j = 0; j < 4; ++j)
                {
                    d = (d << 8) | key[n];
                    n = (n + 1) % key.Length;
                }
                P[i] ^= d;
            }

            uint l = 0, r = 0;
            for (int i = 0; i < 18; i += 2)
            {
                Enc(ref l, ref r);
                P[i] = l;
                P[i + 1] = r;
            }

            for (int i = 0; i < 4; ++i)
            {
                for (int j = 0; j < 256; j += 2)
                {
                    Enc(ref l, ref r);
                    S[i, j] = l;
                    S[i, j + 1] = r;
                }
            }
        }

        private void Enc(ref uint l, ref uint r)
        {
            l ^= P[0];
            r ^= (((S[0, (l >> 24) & 0xFF] + S[1, (l >> 16) & 0xFF]) ^ S[2, (l >> 8) & 0xFF]) + S[3, l & 0xFF]) ^ P[1];
            l ^= (((S[0, (r >> 24) & 0xFF] + S[1, (r >> 16) & 0xFF]) ^ S[2, (r >> 8) & 0xFF]) + S[3, r & 0xFF]) ^ P[2];
            r ^= (((S[0, (l >> 24) & 0xFF] + S[1, (l >> 16) & 0xFF]) ^ S[2, (l >> 8) & 0xFF]) + S[3, l & 0xFF]) ^ P[3];
            l ^= (((S[0, (r >> 24) & 0xFF] + S[1, (r >> 16) & 0xFF]) ^ S[2, (r >> 8) & 0xFF]) + S[3, r & 0xFF]) ^ P[4];
            r ^= (((S[0, (l >> 24) & 0xFF] + S[1, (l >> 16) & 0xFF]) ^ S[2, (l >> 8) & 0xFF]) + S[3, l & 0xFF]) ^ P[5];
            l ^= (((S[0, (r >> 24) & 0xFF] + S[1, (r >> 16) & 0xFF]) ^ S[2, (r >> 8) & 0xFF]) + S[3, r & 0xFF]) ^ P[6];
            r ^= (((S[0, (l >> 24) & 0xFF] + S[1, (l >> 16) & 0xFF]) ^ S[2, (l >> 8) & 0xFF]) + S[3, l & 0xFF]) ^ P[7];
            l ^= (((S[0, (r >> 24) & 0xFF] + S[1, (r >> 16) & 0xFF]) ^ S[2, (r >> 8) & 0xFF]) + S[3, r & 0xFF]) ^ P[8];
            r ^= (((S[0, (l >> 24) & 0xFF] + S[1, (l >> 16) & 0xFF]) ^ S[2, (l >> 8) & 0xFF]) + S[3, l & 0xFF]) ^ P[9];
            l ^= (((S[0, (r >> 24) & 0xFF] + S[1, (r >> 16) & 0xFF]) ^ S[2, (r >> 8) & 0xFF]) + S[3, r & 0xFF]) ^ P[10];
            r ^= (((S[0, (l >> 24) & 0xFF] + S[1, (l >> 16) & 0xFF]) ^ S[2, (l >> 8) & 0xFF]) + S[3, l & 0xFF]) ^ P[11];
            l ^= (((S[0, (r >> 24) & 0xFF] + S[1, (r >> 16) & 0xFF]) ^ S[2, (r >> 8) & 0xFF]) + S[3, r & 0xFF]) ^ P[12];
            r ^= (((S[0, (l >> 24) & 0xFF] + S[1, (l >> 16) & 0xFF]) ^ S[2, (l >> 8) & 0xFF]) + S[3, l & 0xFF]) ^ P[13];
            l ^= (((S[0, (r >> 24) & 0xFF] + S[1, (r >> 16) & 0xFF]) ^ S[2, (r >> 8) & 0xFF]) + S[3, r & 0xFF]) ^ P[14];
            r ^= (((S[0, (l >> 24) & 0xFF] + S[1, (l >> 16) & 0xFF]) ^ S[2, (l >> 8) & 0xFF]) + S[3, l & 0xFF]) ^ P[15];
            l ^= (((S[0, (r >> 24) & 0xFF] + S[1, (r >> 16) & 0xFF]) ^ S[2, (r >> 8) & 0xFF]) + S[3, r & 0xFF]) ^ P[16];
            r ^= P[17];
        }

        public byte[] Decode(byte[] buffer)
        {
            if (buffer == null || buffer.Length < 8) return buffer;

            // Decrypt in 8-byte blocks
            // Note: If buffer length is not multiple of 8, we handle only the complete blocks
            int n = buffer.Length / 8;
            for (int i = 0; i < n; i++)
            {
                uint l = (uint)(buffer[i * 8 + 0]) | (uint)(buffer[i * 8 + 1] << 8) | (uint)(buffer[i * 8 + 2] << 16) | (uint)(buffer[i * 8 + 3] << 24);
                uint r = (uint)(buffer[i * 8 + 4]) | (uint)(buffer[i * 8 + 5] << 8) | (uint)(buffer[i * 8 + 6] << 16) | (uint)(buffer[i * 8 + 7] << 24);

                Dec(ref l, ref r);

                buffer[i * 8 + 0] = (byte)(l);
                buffer[i * 8 + 1] = (byte)(l >> 8);
                buffer[i * 8 + 2] = (byte)(l >> 16);
                buffer[i * 8 + 3] = (byte)(l >> 24);
                buffer[i * 8 + 4] = (byte)(r);
                buffer[i * 8 + 5] = (byte)(r >> 8);
                buffer[i * 8 + 6] = (byte)(r >> 16);
                buffer[i * 8 + 7] = (byte)(r >> 24);
            }
            return buffer;
        }

        private void Dec(ref uint l, ref uint r)
        {
            l ^= P[17];
            r ^= (((S[0, (l >> 24) & 0xFF] + S[1, (l >> 16) & 0xFF]) ^ S[2, (l >> 8) & 0xFF]) + S[3, l & 0xFF]) ^ P[16];
            l ^= (((S[0, (r >> 24) & 0xFF] + S[1, (r >> 16) & 0xFF]) ^ S[2, (r >> 8) & 0xFF]) + S[3, r & 0xFF]) ^ P[15];
            r ^= (((S[0, (l >> 24) & 0xFF] + S[1, (l >> 16) & 0xFF]) ^ S[2, (l >> 8) & 0xFF]) + S[3, l & 0xFF]) ^ P[14];
            l ^= (((S[0, (r >> 24) & 0xFF] + S[1, (r >> 16) & 0xFF]) ^ S[2, (r >> 8) & 0xFF]) + S[3, r & 0xFF]) ^ P[13];
            r ^= (((S[0, (l >> 24) & 0xFF] + S[1, (l >> 16) & 0xFF]) ^ S[2, (l >> 8) & 0xFF]) + S[3, l & 0xFF]) ^ P[12];
            l ^= (((S[0, (r >> 24) & 0xFF] + S[1, (r >> 16) & 0xFF]) ^ S[2, (r >> 8) & 0xFF]) + S[3, r & 0xFF]) ^ P[11];
            r ^= (((S[0, (l >> 24) & 0xFF] + S[1, (l >> 16) & 0xFF]) ^ S[2, (l >> 8) & 0xFF]) + S[3, l & 0xFF]) ^ P[10];
            l ^= (((S[0, (r >> 24) & 0xFF] + S[1, (r >> 16) & 0xFF]) ^ S[2, (r >> 8) & 0xFF]) + S[3, r & 0xFF]) ^ P[9];
            r ^= (((S[0, (l >> 24) & 0xFF] + S[1, (l >> 16) & 0xFF]) ^ S[2, (l >> 8) & 0xFF]) + S[3, l & 0xFF]) ^ P[8];
            l ^= (((S[0, (r >> 24) & 0xFF] + S[1, (r >> 16) & 0xFF]) ^ S[2, (r >> 8) & 0xFF]) + S[3, r & 0xFF]) ^ P[7];
            r ^= (((S[0, (l >> 24) & 0xFF] + S[1, (l >> 16) & 0xFF]) ^ S[2, (l >> 8) & 0xFF]) + S[3, l & 0xFF]) ^ P[6];
            l ^= (((S[0, (r >> 24) & 0xFF] + S[1, (r >> 16) & 0xFF]) ^ S[2, (r >> 8) & 0xFF]) + S[3, r & 0xFF]) ^ P[5];
            r ^= (((S[0, (l >> 24) & 0xFF] + S[1, (l >> 16) & 0xFF]) ^ S[2, (l >> 8) & 0xFF]) + S[3, l & 0xFF]) ^ P[4];
            l ^= (((S[0, (r >> 24) & 0xFF] + S[1, (r >> 16) & 0xFF]) ^ S[2, (r >> 8) & 0xFF]) + S[3, r & 0xFF]) ^ P[3];
            r ^= (((S[0, (l >> 24) & 0xFF] + S[1, (l >> 16) & 0xFF]) ^ S[2, (l >> 8) & 0xFF]) + S[3, l & 0xFF]) ^ P[2];
            l ^= (((S[0, (r >> 24) & 0xFF] + S[1, (r >> 16) & 0xFF]) ^ S[2, (r >> 8) & 0xFF]) + S[3, r & 0xFF]) ^ P[1];
            r ^= P[0];
        }
    }
}
